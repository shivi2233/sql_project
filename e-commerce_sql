SELECT 
    p.category,
    SUM(oi.quantity * oi.unit_price) AS revenue
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.category
ORDER BY revenue DESC;

% of customers who placed more than one order.

WITH order_count AS (
    SELECT customer_id, COUNT(*) AS total_orders
    FROM orders
    GROUP BY customer_id
)
SELECT 
    (SUM(CASE WHEN total_orders > 1 THEN 1 ELSE 0 END)::float 
     / COUNT(*)) * 100 AS repeat_purchase_rate_percent
FROM order_count;

✅ 3. Cohort Analysis (Monthly signup vs monthly orders)

Tracks retention of customers.

WITH customer_cohort AS (
    SELECT 
        c.customer_id,
        DATE_TRUNC('month', c.signup_date) AS cohort_month
    FROM customers c
),
order_month AS (
    SELECT 
        o.customer_id,
        DATE_TRUNC('month', o.order_date) AS active_month
    FROM orders o
)
SELECT 
    cc.cohort_month,
    om.active_month,
    COUNT(DISTINCT om.customer_id) AS active_users
FROM customer_cohort cc
JOIN order_month om USING (customer_id)
GROUP BY 1,2
ORDER BY 1,2;

✅ 4. Most Profitable Customers (CLV-style contribution)

Sorted by revenue generated.

SELECT 
    o.customer_id,
    SUM(oi.quantity * oi.unit_price) AS total_revenue
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY o.customer_id
ORDER BY total_revenue DESC
LIMIT 10;

✅ 5. AOV (Average Order Value) Trend — Month-wise
SELECT
    DATE_TRUNC('month', o.order_date) AS month,
    SUM(oi.quantity * oi.unit_price) / COUNT(DISTINCT o.order_id) AS avg_order_value
FROM orders o
JOIN order_items oi USING(order_id)
GROUP BY 1
ORDER BY 1;

✅ 6. City-wise Demand Analysis

Top cities by number of orders.

SELECT
    c.city,
    COUNT(DISTINCT o.order_id) AS total_orders,
    SUM(oi.quantity) AS total_items_sold
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
GROUP BY c.city
ORDER BY total_orders DESC;

✅ 7. Month-on-Month Growth (%)

Revenue growth from previous month.

WITH monthly_revenue AS (
    SELECT
        DATE_TRUNC('month', o.order_date) AS month,
        SUM(oi.quantity * oi.unit_price) AS revenue
    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    GROUP BY 1
)
SELECT
    month,
    revenue,
    LAG(revenue) OVER (ORDER BY month) AS previous_month_revenue,
    ROUND(
        (revenue - LAG(revenue) OVER (ORDER BY month)) 
        / NULLIF(LAG(revenue) OVER (ORDER BY month), 0) * 100, 2
    ) AS mom_growth_percent
FROM monthly_revenue
ORDER BY month;
